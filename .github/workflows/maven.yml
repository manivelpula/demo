name: MuleSoft CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout source code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Set up Java
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      # 3️⃣ Build + Run MUnit tests
      - name: Build and run MUnit tests
        run: |
          mvn -B clean test \
            -Dmule.env=ci

      # 4️⃣ Package Mule application
      - name: Package Mule application
        run: |
          mvn -B package -DskipTests

      # 5️⃣ Upload artifact (optional)
      - name: Upload Mule artifact
        uses: actions/upload-artifact@v4
        with:
          name: mule-application
          path: target/*.jar

      # 6️⃣ ✅ Deploy to CloudHub 2.0
      - name: Deploy Mule application to CloudHub 2.0
        working-directory: demo   # <-- set to folder containing your pom.xml
        run: |
          mvn clean deploy -Pcloudhub-2.0 \
            -Danypoint.client_id=e85c250d7185443eaf380821bdd543c \
            -Danypoint.client_secret=Ec0b12d15A31457bB80B502CeD1b9835 \
            -Danypoint.env=b20afc88-ff74-418c-a940-eee7bfee0af8 \
            -Danypoint.org=c39dc6dd-e124-4390-867b-7b58e9d44727 \
            <runtimeVersion>4.9.12</runtimeVersion>
              

